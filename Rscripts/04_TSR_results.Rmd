---
title: "Temperature size rule results"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
    toc: yes
    theme: "lumen"
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(broom)
library(gridExtra)
library(lubridate)
library(plotrix)
library(stringr)
```


### Background

Something here about the TSR being the third 'universal' response to warming. However, the mechanisms responsible for this widespread pattern are unknown blah blah blah, particularly w/r/t whether being smaller at warmer temperatures is associated with higher fitness. Or else why would this pattern be so prevalent in nature?


```{r message=FALSE, warning=FALSE}
data3 <- read_csv("/Users/Joey/Documents/Daph-TSR/data-processed/data3.csv")
```


### Reproductive rate
How does reproductive rate vary with temperature?
```{r reproductive rate, echo=FALSE, warning=FALSE}
data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	ggplot(data = ., aes(x = inverse_temp, y = log(time_to_first_clutch), label = id)) + geom_point(size = 4, color = "#619CFF") +
	geom_smooth(method = "lm", color = "#619CFF") +
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("ln time to reproductive maturity") + 
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1)) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

```{r}
data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	do(tidy(lm(log(time_to_first_clutch) ~ inverse_temp, data = .), conf.int = TRUE)) %>%
	knitr::kable(.)
```


Time between clutches

```{r time between clutches, echo=FALSE, warning=FALSE}
data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	ggplot(data = ., aes(x = inverse_temp, y = log(time_btw_1_2), label = id)) + geom_point(size = 4, color = "#619CFF") +
	geom_smooth(method = "lm", color = "#619CFF") +
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("time between clutches") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1)) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

```{r}
## time between clutches
data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	do(tidy(lm(log(time_btw_1_2) ~ inverse_temp, data = .), conf.int = TRUE)) %>%
	knitr::kable(.)
```

### Body size

```{r body size, echo=FALSE, warning = FALSE, message = FALSE}
data4 <- data3 %>% 
	gather(clutch_number, length, starts_with("length")) %>% 
	mutate(clutch_number = str_replace(clutch_number, "length_at_1st_clutch", "1st clutch")) %>% 
	mutate(clutch_number = str_replace(clutch_number, "length_at_2nd_clutch_um", "2nd clutch")) %>% 
	mutate(clutch_number = str_replace(clutch_number, "length_at_3rd_clutch", "3rd clutch")) %>% 
	mutate(clutch_number = str_replace(clutch_number, "length_at_4th_clutch", "4th clutch")) %>% 
	mutate(clutch_number = str_replace(clutch_number, "length_at_birth_um", "birth")) 
	

data4 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	group_by(clutch_number) %>% 
	ggplot(data = ., aes(x = inverse_temp, y = log(length), color = factor(clutch_number))) + geom_point(size = 5, alpha = 0.5) +
	geom_smooth(method = "lm") +
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("ln length (um)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

### Somatic growth rates

```{r, echo=FALSE, message=FALSE, warning=FALSE}
## get to somatic growth rate by taking the difference in length at 1st clutch and length at birth, divided by the days to first clutch

data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	mutate(somatic_growth_rate = ((length_at_1st_clutch - length_at_birth_um)/time_to_first_clutch)) %>%
	ggplot(data = ., aes(x = inverse_temp, y = log(somatic_growth_rate), label = id)) + geom_point(size = 4, color = "#619CFF", alpha = 0.5) +
	geom_smooth(method = "lm", color = "#619CFF") +
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("ln somatic growth rate (um/day)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

```{r}
data3 %>% 
	filter(unique_id != "K_16") %>% ## something weird is going on here!
	mutate(inverse_temp = (-1/(.00008617*(temperature+273.15)))) %>%
	mutate(somatic_growth_rate = ((length_at_1st_clutch - length_at_birth_um)/time_to_first_clutch)) %>%
do(tidy(lm(log(somatic_growth_rate) ~ inverse_temp, data = .), conf.int = TRUE)) %>%
	knitr::kable(.)
```

### Size rate trade-off??

```{r, echo=FALSE, message=FALSE, warning=FALSE}
data7 <- read_csv("/Users/Joey/Documents/Daph-TSR/data-processed/data7.csv")


data7 %>% 
	# filter(temperature > 13) %>% 
ggplot(aes(x = somatic_growth_rate, y = max_length)) + geom_point(size = 4, color = "#619CFF", alpha = 0.5) +
geom_smooth(method = "lm", color = "#619CFF") +
	xlab("somatic growth rate (um/day)") + ylab("max body length (um)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

Body size over time
```{r, echo=FALSE, message=FALSE, warning=FALSE}
lengths_ann_raw <- read_csv("/Users/Joey/Documents/Daph-TSR/data-processed/lengths_all_adult_annotated.csv")
lengths_all <- read_csv("/Users/Joey/Documents/Daph-TSR/data-processed/lengths_all.csv")


lengths_ann <- lengths_ann_raw %>% 
	mutate(date = mdy(date))

lengths_birth <- lengths_all %>%
	filter(life_stage == "birth") %>% 
	mutate(unique_id = str_replace(unique_id, "2N1.2", "N")) %>% 
	mutate(unique_id = str_replace(unique_id, "2N1.3", "N")) %>%
	mutate(unique_id = str_replace(unique_id, "2N1.4", "N")) %>% 
	mutate(unique_id = str_replace(unique_id, "2N1.8", "N")) %>%
	mutate(unique_id = str_replace(unique_id, "2N1.5", "N")) %>% 
	mutate(unique_id = str_replace(unique_id, "2N1.1", "N")) %>%
	separate(unique_id, into = c("letter", "temp"), remove = FALSE) 

lengths_b2m <- bind_rows(lengths_ann, lengths_birth)


### yes this is it!!
lengths_b2m %>% 
	mutate(certainty = ifelse(life_stage == "birth", "yes", certainty)) %>%
	# filter(version == 2) %>%
	filter(certainty == "yes") %>% 
	# filter(life_stage == "birth") %>% 
	# filter(temperature == 16) %>% 
	ggplot(aes(date, y = length, color = letter, group = letter)) + geom_point(size = 3) +
	geom_line() + facet_wrap( ~ temperature)
```


Minimum adult body size
```{r, echo=FALSE, message=FALSE, warning=FALSE}
lengths_all_adult <- read_csv("/Users/Joey/Documents/Daph-TSR/data-processed/lengths_all_adult.csv")

lengths_all_adult %>% 
filter(temperature > 10) %>% 
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	filter(length > 1000) %>% 
	group_by(inverse_temp) %>% 
	summarise_each(funs(mean, min, max, std.error), length) %>%
	ggplot(aes(x = inverse_temp, y = min)) + geom_point(size = 4) +
	# geom_smooth() + 
	geom_errorbar(aes(ymin = min - std.error, ymax = min + std.error), width = 0.1) + 
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("minimum adult body length (um)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```


Maximum adult body size
```{r, echo=FALSE, message=FALSE, warning=FALSE}
lengths_all_adult %>% 
filter(temperature > 10) %>% 
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	filter(length > 1000) %>% 
	group_by(inverse_temp) %>% 
	summarise_each(funs(mean, min, max, std.error), length) %>%
	ggplot(aes(x = inverse_temp, y = max)) + geom_point(size = 4) +
	# geom_smooth() + 
	geom_errorbar(aes(ymin = max - std.error, ymax = max + std.error), width = 0.1) + 
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("max adult body length (um)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

Mean adult body size
```{r, echo=FALSE, message=FALSE, warning=FALSE}
lengths_all_adult %>% 
filter(temperature > 10) %>% 
	mutate(inverse_temp = (1/(.00008617*(temperature+273.15)))) %>%
	filter(length > 1000) %>% 
	group_by(inverse_temp) %>% 
	summarise_each(funs(mean, min, max, std.error), length) %>%
	ggplot(aes(x = inverse_temp, y = mean)) + geom_point(size = 4) +
	# geom_smooth() + 
	geom_errorbar(aes(ymin = mean - std.error, ymax = mean + std.error), width = 0.1) + 
	scale_x_reverse() + xlab("temperature (1/kT)") + ylab("average adult body length (um)") +
	theme_minimal() + 
	theme(axis.text.y   = element_text(size=20),
				axis.text.x   = element_text(size=20),
				axis.title.y  = element_text(size=20),
				axis.title.x  = element_text(size=20),
				panel.background = element_blank(),
				panel.grid.major = element_blank(), 
				panel.grid.minor = element_blank(),
				axis.line = element_line(colour = "black"),
				axis.ticks = element_line(size = 1),
				legend.title = element_blank()) +
	theme(panel.border = element_blank(), axis.line = element_line(colour="black", size=1, lineend="square"))
```

